import{f as d,y as de,i as ce,c as f,b as e,j as h,q as V,z as k,A as pe,t as b,n as me,F as B,k as O,B as H,e as ve,o as y}from"./index-6DAA1hwU.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";const I="https://api.github.com/repos/OUTshipping/OUTshipping.github.io",P="source",j="main";function U(p){return{Authorization:`Bearer ${p}`,Accept:"application/vnd.github.v3+json","Content-Type":"application/json"}}async function fe(p){try{const i=await fetch(`${I}`,{headers:U(p)});if(!i.ok)return{valid:!1,message:"无效的 Token 或无权访问此仓库"};const r=await i.json();return!r.permissions||!r.permissions.push?{valid:!1,message:"Token 没有对此仓库的写入权限"}:{valid:!0,message:"验证成功"}}catch(i){return{valid:!1,message:`网络错误: ${i.message}`}}}async function K(p,i){const r=await fetch(`${I}/contents/${i}?ref=${P}`,{headers:U(p)});if(!r.ok)throw new Error(`获取文件失败: ${r.status} ${r.statusText}`);const v=await r.json();return{content:decodeURIComponent(escape(atob(v.content.replace(/\n/g,"")))),sha:v.sha}}async function z(p,i,r,v,c){const u=await fetch(`${I}/contents/${i}`,{method:"PUT",headers:U(p),body:JSON.stringify({message:c,content:btoa(unescape(encodeURIComponent(r))),sha:v,branch:P})});if(!u.ok){const l=await u.json();throw new Error(`更新文件失败: ${l.message||JSON.stringify(l)}`)}return await u.json()}async function Y(p,i,r,v){const c=await fetch(`${I}/contents/${i}`,{method:"PUT",headers:U(p),body:JSON.stringify({message:v,content:r,branch:P})});if(!c.ok){const l=await c.json();throw new Error(`上传图片失败: ${l.message||JSON.stringify(l)}`)}const u=await c.json();if(i.startsWith("public/")){const l=i.replace(/^public\//,"");try{let g;const w=await fetch(`${I}/contents/${l}?ref=${j}`,{headers:U(p)});w.ok&&(g=(await w.json()).sha);const C={message:`deploy: ${v}`,content:r,branch:j};g&&(C.sha=g),await fetch(`${I}/contents/${l}`,{method:"PUT",headers:U(p),body:JSON.stringify(C)})}catch(g){console.warn("图片同步到 main 分支失败:",g)}}return u}async function he(p){const i=await fetch(`${I}/contents/public/data/vehicles.json?ref=${P}`,{headers:U(p)});if(!i.ok)throw new Error(`读取 source 分支数据失败: ${i.status} ${i.statusText}`);const v=(await i.json()).content.replace(/\n/g,""),c=await fetch(`${I}/contents/data/vehicles.json?ref=${j}`,{headers:U(p)});if(!c.ok)throw new Error(`读取 main 分支数据失败: ${c.status} ${c.statusText}`);const l=(await c.json()).sha,g=await fetch(`${I}/contents/data/vehicles.json`,{method:"PUT",headers:U(p),body:JSON.stringify({message:"deploy: sync vehicles data to live site",content:v,sha:l,branch:j})});if(!g.ok){const w=await g.json();throw new Error(`部署到 main 失败: ${w.message||JSON.stringify(w)}`)}return await g.json()}const ye={class:"admin-page"},be={key:0,class:"login-container"},we={class:"login-card"},ke={class:"login-form"},$e=["disabled"],Ce={key:0,class:"error-msg"},Se={key:1,class:"admin-container"},Ie={class:"admin-header"},Ue={class:"header-actions"},_e=["disabled"],Ae={key:1,class:"vehicle-list"},Ve={class:"list-header"},De=["disabled"],Te={class:"vehicle-table"},Ee=["src","alt"],Re={class:"switch"},Ne=["checked","onChange"],je={class:"actions-cell"},Pe=["onClick"],xe=["onClick"],Fe={key:2,class:"form-container"},Be={class:"form-grid"},Oe={class:"form-group"},Le={class:"form-group"},Je={class:"form-group"},Me={class:"form-group"},Ge={class:"form-group"},He={class:"form-group"},Ke={class:"form-group full-width"},ze={class:"form-grid"},Ye={class:"form-group"},qe={class:"form-group"},We={class:"form-group"},Qe={class:"form-group"},Xe={class:"form-group"},Ze={class:"colors-editor"},et=["onUpdate:modelValue"],tt=["onClick"],st={class:"image-upload-section"},at={key:0,class:"current-cover"},nt=["src"],ot={class:"image-upload-section"},lt={class:"detail-images-grid"},it=["src"],rt=["onClick"],ut={class:"form-actions"},dt=["disabled"],ct={__name:"AdminView",setup(p){const i=d(!1),r=d(""),v=d(!1),c=d("");let u="";const l=d([]),g=d(!1),w=d(""),C=d(!1),_=d(!1),D=d(null),T=d(!1),E=d(!1),q=d(null),W=d(null),R=d(""),L=d("info"),A=d(null),S=d([]),J=()=>({name:"",slug:"",type:"SUV",range:0,seats:5,configuration:"Basic",description:"",coverImage:"",colors:["#000000"],specs:{year:"2025",make:"",model:"",category:"",batteryCapacity:"N/A"},detailImages:[]}),a=de(J());async function M(){v.value=!0,c.value="";try{const n=await fe(r.value);n.valid?(u=r.value,i.value=!0,sessionStorage.setItem("gh_token",u),await x()):c.value=n.message}catch(n){c.value=n.message}finally{v.value=!1}}function Q(){i.value=!1,u="",sessionStorage.removeItem("gh_token"),l.value=[]}async function x(){g.value=!0;try{const{content:n,sha:t}=await K(u,"public/data/vehicles.json");l.value=JSON.parse(n),w.value=t}catch(n){$("Failed to load vehicles: "+n.message,"error")}finally{g.value=!1}}async function X(n){n.enabled=!n.enabled,await F("Toggle vehicle: "+n.name)}function Z(){Object.assign(a,J()),A.value=null,S.value=[],_.value=!1,D.value=null,C.value=!0}function ee(n){Object.assign(a,{name:n.name,slug:n.slug,type:n.type,range:n.range,seats:n.seats,configuration:n.configuration,description:n.description,coverImage:n.coverImage,colors:[...n.colors],specs:{...n.specs},detailImages:[...n.detailImages]}),A.value=null,S.value=[],_.value=!0,D.value=n.id,C.value=!0}function te(){C.value=!1}function se(n){const t=n.target.files[0];if(!t)return;A.value=t;const s=new FileReader;s.onload=o=>{a.coverImage=o.target.result},s.readAsDataURL(t)}function ae(n){Array.from(n.target.files).forEach(s=>{S.value.push(s);const o=new FileReader;o.onload=m=>{a.detailImages.push(m.target.result)},o.readAsDataURL(s)})}function ne(n){a.detailImages.splice(n,1),n<S.value.length&&S.value.splice(n,1)}function G(n){return new Promise((t,s)=>{const o=new FileReader;o.onload=()=>{const m=o.result.split(",")[1];t(m)},o.onerror=s,o.readAsDataURL(n)})}function $(n,t="info"){R.value=n,L.value=t,setTimeout(()=>{R.value=""},5e3)}async function oe(n){confirm(`Are you sure you want to delete "${n.name}"?`)&&(l.value=l.value.filter(t=>t.id!==n.id),await F("Delete vehicle: "+n.name))}async function F(n){try{const t=JSON.stringify(l.value,null,2),s=await z(u,"public/data/vehicles.json",t,w.value,n);w.value=s.content.sha,$("Saved successfully! Site will update in 1-2 minutes.","success")}catch(t){if(t.message&&t.message.includes("does not match"))try{$("SHA mismatch, retrying...","info");const{sha:s}=await K(u,"public/data/vehicles.json");w.value=s;const o=JSON.stringify(l.value,null,2),m=await z(u,"public/data/vehicles.json",o,w.value,n);w.value=m.content.sha,$("Saved successfully! Site will update in 1-2 minutes.","success")}catch(s){$("Save failed after retry: "+s.message,"error")}else $("Save failed: "+t.message,"error")}}async function le(){if(confirm("确认将当前数据部署到前台网站？")){E.value=!0;try{await he(u),$("Deployed successfully! Live site will update in ~1 minute.","success")}catch(n){$("Deploy failed: "+n.message,"error")}finally{E.value=!1}}}async function ie(){if(!a.name||!a.slug||!a.type){$("Please fill in all required fields.","error");return}T.value=!0;try{const n=a.slug;if(A.value){const o=A.value.name.split(".").pop(),m=`public/vehicles/${n}/cover.${o}`,N=await G(A.value);await Y(u,m,N,`Upload cover for ${a.name}`),a.coverImage=`/vehicles/${n}/cover.${o}`}const t=a.detailImages.length-S.value.length;for(let o=0;o<S.value.length;o++){const m=S.value[o],N=m.name.split(".").pop(),re=`public/vehicles/${n}/${t+o+1}.${N}`,ue=await G(m);await Y(u,re,ue,`Upload image for ${a.name}`),a.detailImages[t+o]=`/vehicles/${n}/${t+o+1}.${N}`}const s={id:_.value?D.value:Math.max(0,...l.value.map(o=>o.id))+1,slug:a.slug,enabled:!0,name:a.name,type:a.type,range:a.range,seats:a.seats,configuration:a.configuration,coverImage:a.coverImage,colors:[...a.colors],description:a.description,specs:{...a.specs},detailImages:[...a.detailImages]};if(_.value){const o=l.value.findIndex(m=>m.id===D.value);o!==-1&&(s.enabled=l.value[o].enabled,l.value[o]=s)}else l.value.push(s);await F(_.value?`Update vehicle: ${a.name}`:`Add vehicle: ${a.name}`),C.value=!1,A.value=null,S.value=[]}catch(n){$("Save failed: "+n.message,"error")}finally{T.value=!1}}return ce(()=>{const n=sessionStorage.getItem("gh_token");n&&(u=n,i.value=!0,x())}),(n,t)=>(y(),f("div",ye,[i.value?(y(),f("div",Se,[e("header",Ie,[t[16]||(t[16]=e("h1",null,"Vehicle Management",-1)),e("div",Ue,[e("button",{class:"btn-add",onClick:Z},"+ Add Vehicle"),e("button",{class:"btn-deploy",onClick:le,disabled:E.value},b(E.value?"Deploying...":"Deploy to Live Site"),9,_e),e("button",{class:"btn-logout",onClick:Q},"Logout")])]),R.value?(y(),f("div",{key:0,class:me(["status-bar",L.value])},b(R.value),3)):V("",!0),C.value?V("",!0):(y(),f("div",Ae,[e("div",Ve,[e("span",null,"Total: "+b(l.value.length)+" vehicles",1),e("button",{class:"btn-refresh",onClick:x,disabled:g.value},b(g.value?"Loading...":"Refresh"),9,De)]),e("table",Te,[t[18]||(t[18]=e("thead",null,[e("tr",null,[e("th",null,"ID"),e("th",null,"Image"),e("th",null,"Name"),e("th",null,"Type"),e("th",null,"Range"),e("th",null,"Status"),e("th",null,"Actions")])],-1)),e("tbody",null,[(y(!0),f(B,null,O(l.value,s=>(y(),f("tr",{key:s.id},[e("td",null,b(s.id),1),e("td",null,[e("img",{src:s.coverImage,alt:s.name,class:"thumb"},null,8,Ee)]),e("td",null,b(s.name),1),e("td",null,b(s.type),1),e("td",null,b(s.range)+" km",1),e("td",null,[e("label",Re,[e("input",{type:"checkbox",checked:s.enabled,onChange:o=>X(s)},null,40,Ne),t[17]||(t[17]=e("span",{class:"slider"},null,-1))])]),e("td",je,[e("button",{class:"btn-edit",onClick:o=>ee(s)},"Edit",8,Pe),e("button",{class:"btn-delete",onClick:o=>oe(s)},"Delete",8,xe)])]))),128))])])])),C.value?(y(),f("div",Fe,[e("h2",null,b(_.value?"Edit Vehicle":"Add New Vehicle"),1),e("div",Be,[e("div",Oe,[t[19]||(t[19]=e("label",null,"Name *",-1)),h(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>a.name=s),type:"text",placeholder:"e.g. 2025 BYD Song Plus"},null,512),[[k,a.name]])]),e("div",Le,[t[20]||(t[20]=e("label",null,"Slug *",-1)),h(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>a.slug=s),type:"text",placeholder:"e.g. song-plus"},null,512),[[k,a.slug]])]),e("div",Je,[t[22]||(t[22]=e("label",null,"Type *",-1)),h(e("select",{"onUpdate:modelValue":t[3]||(t[3]=s=>a.type=s)},[...t[21]||(t[21]=[ve('<option value="SUV" data-v-a87d3d2c>SUV</option><option value="SEDAN" data-v-a87d3d2c>SEDAN</option><option value="VAN" data-v-a87d3d2c>VAN</option><option value="PICKUP" data-v-a87d3d2c>PICKUP</option><option value="TRUCK" data-v-a87d3d2c>TRUCK</option><option value="REFRIGERATED" data-v-a87d3d2c>REFRIGERATED</option><option value="BUS" data-v-a87d3d2c>BUS</option>',7)])],512),[[H,a.type]])]),e("div",Me,[t[23]||(t[23]=e("label",null,"Range (km) *",-1)),h(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>a.range=s),type:"number",placeholder:"e.g. 520"},null,512),[[k,a.range,void 0,{number:!0}]])]),e("div",Ge,[t[24]||(t[24]=e("label",null,"Seats *",-1)),h(e("input",{"onUpdate:modelValue":t[5]||(t[5]=s=>a.seats=s),type:"number",placeholder:"e.g. 5"},null,512),[[k,a.seats,void 0,{number:!0}]])]),e("div",He,[t[26]||(t[26]=e("label",null,"Configuration",-1)),h(e("select",{"onUpdate:modelValue":t[6]||(t[6]=s=>a.configuration=s)},[...t[25]||(t[25]=[e("option",{value:"Basic"},"Basic",-1),e("option",{value:"Premium"},"Premium",-1),e("option",{value:"Commercial"},"Commercial",-1)])],512),[[H,a.configuration]])]),e("div",Ke,[t[27]||(t[27]=e("label",null,"Description",-1)),h(e("textarea",{"onUpdate:modelValue":t[7]||(t[7]=s=>a.description=s),rows:"4",placeholder:"Vehicle description..."},null,512),[[k,a.description]])])]),t[33]||(t[33]=e("h3",null,"Specifications",-1)),e("div",ze,[e("div",Ye,[t[28]||(t[28]=e("label",null,"Year",-1)),h(e("input",{"onUpdate:modelValue":t[8]||(t[8]=s=>a.specs.year=s),type:"text",placeholder:"2025"},null,512),[[k,a.specs.year]])]),e("div",qe,[t[29]||(t[29]=e("label",null,"Make",-1)),h(e("input",{"onUpdate:modelValue":t[9]||(t[9]=s=>a.specs.make=s),type:"text",placeholder:"BYD"},null,512),[[k,a.specs.make]])]),e("div",We,[t[30]||(t[30]=e("label",null,"Model",-1)),h(e("input",{"onUpdate:modelValue":t[10]||(t[10]=s=>a.specs.model=s),type:"text",placeholder:"Song Plus"},null,512),[[k,a.specs.model]])]),e("div",Qe,[t[31]||(t[31]=e("label",null,"Category",-1)),h(e("input",{"onUpdate:modelValue":t[11]||(t[11]=s=>a.specs.category=s),type:"text",placeholder:"PASSENGER"},null,512),[[k,a.specs.category]])]),e("div",Xe,[t[32]||(t[32]=e("label",null,"Battery Capacity",-1)),h(e("input",{"onUpdate:modelValue":t[12]||(t[12]=s=>a.specs.batteryCapacity=s),type:"text",placeholder:"71.7 kWh"},null,512),[[k,a.specs.batteryCapacity]])])]),t[34]||(t[34]=e("h3",null,"Colors",-1)),e("div",Ze,[(y(!0),f(B,null,O(a.colors,(s,o)=>(y(),f("div",{key:o,class:"color-item"},[h(e("input",{type:"color","onUpdate:modelValue":m=>a.colors[o]=m},null,8,et),[[k,a.colors[o]]]),e("span",null,b(s),1),e("button",{class:"btn-remove-sm",onClick:m=>a.colors.splice(o,1)},"x",8,tt)]))),128)),e("button",{class:"btn-add-color",onClick:t[13]||(t[13]=s=>a.colors.push("#000000"))},"+ Add Color")]),t[35]||(t[35]=e("h3",null,"Cover Image",-1)),e("div",st,[a.coverImage?(y(),f("div",at,[e("img",{src:a.coverImage,alt:"Cover",class:"preview-img"},null,8,nt)])):V("",!0),e("input",{type:"file",accept:"image/*",onChange:se,ref_key:"coverInput",ref:q},null,544)]),t[36]||(t[36]=e("h3",null,"Detail Images",-1)),e("div",ot,[e("div",lt,[(y(!0),f(B,null,O(a.detailImages,(s,o)=>(y(),f("div",{key:o,class:"detail-img-item"},[e("img",{src:s,alt:"Detail",class:"preview-img-sm"},null,8,it),e("button",{class:"btn-remove-sm",onClick:m=>ne(o)},"x",8,rt)]))),128))]),e("input",{type:"file",accept:"image/*",multiple:"",onChange:ae,ref_key:"detailInput",ref:W},null,544)]),e("div",ut,[e("button",{class:"btn-save",onClick:ie,disabled:T.value},b(T.value?"Saving...":"Save"),9,dt),e("button",{class:"btn-cancel",onClick:te},"Cancel")])])):V("",!0)])):(y(),f("div",be,[e("div",we,[t[14]||(t[14]=e("h1",null,"TG Automobile Admin",-1)),t[15]||(t[15]=e("p",{class:"login-desc"},"Enter your GitHub Personal Access Token to manage vehicles.",-1)),e("div",ke,[h(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>r.value=s),type:"password",placeholder:"GitHub Personal Access Token",onKeyup:pe(M,["enter"])},null,544),[[k,r.value]]),e("button",{onClick:M,disabled:v.value},b(v.value?"Verifying...":"Login"),9,$e),c.value?(y(),f("p",Ce,b(c.value),1)):V("",!0)])])]))]))}},vt=ge(ct,[["__scopeId","data-v-a87d3d2c"]]);export{vt as default};
