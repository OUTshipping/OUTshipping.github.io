import{f as i,y as Ce,i as $e,c as u,b as t,j as g,q as T,z as k,A as Se,t as v,n as Ue,F as N,k as R,B as P,e as Ie,o as d}from"./index-LZ7bVuRK.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const U="https://api.github.com/repos/OUTshipping/OUTshipping.github.io",J="source",M="main";function I(f){return{Authorization:`Bearer ${f}`,Accept:"application/vnd.github.v3+json","Content-Type":"application/json"}}async function _e(f){try{const r=await fetch(`${U}`,{headers:I(f)});if(!r.ok)return{valid:!1,message:"无效的 Token 或无权访问此仓库"};const c=await r.json();return!c.permissions||!c.permissions.push?{valid:!1,message:"Token 没有对此仓库的写入权限"}:{valid:!0,message:"验证成功"}}catch(r){return{valid:!1,message:`网络错误: ${r.message}`}}}async function Z(f,r){const c=await fetch(`${U}/contents/${r}?ref=${J}`,{headers:I(f)});if(!c.ok)throw new Error(`获取文件失败: ${c.status} ${c.statusText}`);const b=await c.json();return{content:decodeURIComponent(escape(atob(b.content.replace(/\n/g,"")))),sha:b.sha}}async function ee(f,r,c,b,m){const p=await fetch(`${U}/contents/${r}`,{method:"PUT",headers:I(f),body:JSON.stringify({message:m,content:btoa(unescape(encodeURIComponent(c))),sha:b,branch:J})});if(!p.ok){const o=await p.json();throw new Error(`更新文件失败: ${o.message||JSON.stringify(o)}`)}return await p.json()}async function te(f,r,c,b){const m=await fetch(`${U}/contents/${r}`,{method:"PUT",headers:I(f),body:JSON.stringify({message:b,content:c,branch:J})});if(!m.ok){const o=await m.json();throw new Error(`上传图片失败: ${o.message||JSON.stringify(o)}`)}const p=await m.json();if(r.startsWith("public/")){const o=r.replace(/^public\//,"");try{let h;const w=await fetch(`${U}/contents/${o}?ref=${M}`,{headers:I(f)});w.ok&&(h=(await w.json()).sha);const $={message:`deploy: ${b}`,content:c,branch:M};h&&($.sha=h),await fetch(`${U}/contents/${o}`,{method:"PUT",headers:I(f),body:JSON.stringify($)})}catch(h){console.warn("图片同步到 main 分支失败:",h)}}return p}async function Ae(f){const r=await fetch(`${U}/contents/public/data/vehicles.json?ref=${J}`,{headers:I(f)});if(!r.ok)throw new Error(`读取 source 分支数据失败: ${r.status} ${r.statusText}`);const b=(await r.json()).content.replace(/\n/g,""),m=await fetch(`${U}/contents/data/vehicles.json?ref=${M}`,{headers:I(f)});if(!m.ok)throw new Error(`读取 main 分支数据失败: ${m.status} ${m.statusText}`);const o=(await m.json()).sha,h=await fetch(`${U}/contents/data/vehicles.json`,{method:"PUT",headers:I(f),body:JSON.stringify({message:"deploy: sync vehicles data to live site",content:b,sha:o,branch:M})});if(!h.ok){const w=await h.json();throw new Error(`部署到 main 失败: ${w.message||JSON.stringify(w)}`)}return await h.json()}const De={class:"admin-page"},Ee={key:0,class:"login-container"},Te={class:"login-card"},Ne={class:"login-form"},Re=["disabled"],je={key:0,class:"error-msg"},Pe={key:1,class:"admin-container"},xe={class:"admin-header"},Be={class:"header-actions"},Fe=["disabled"],Le={key:1,class:"vehicle-list"},Oe={class:"list-header"},Me=["disabled"],Je={class:"vehicle-table"},Ge=["src","alt"],He={class:"switch"},Ke=["checked","onChange"],ze={class:"actions-cell"},Ye=["onClick"],qe=["onClick"],We={key:2,class:"form-container"},Qe={key:0,class:"db-selector-card"},Xe={class:"db-selector-row"},Ze={class:"db-selector-group"},et=["value"],tt={class:"db-selector-group"},st=["disabled"],at=["value"],nt={class:"db-selector-group"},lt=["disabled"],ot=["value"],it=["disabled"],rt={key:1,class:"db-selector-card"},ut={class:"form-grid"},dt={class:"form-group"},ct={class:"form-group"},pt={class:"form-group"},vt={class:"form-group"},mt={class:"form-group"},gt={class:"form-group"},ft={class:"form-group full-width"},yt={class:"form-grid"},bt={class:"form-group"},ht={class:"form-group"},wt={class:"form-group"},kt={class:"form-group"},Ct={class:"form-group"},$t={class:"colors-editor"},St=["onUpdate:modelValue"],Ut=["onClick"],It={class:"image-upload-section"},Vt={key:0,class:"current-cover"},_t=["src"],At={class:"image-upload-section"},Dt={class:"detail-images-grid"},Et=["src"],Tt=["onClick"],Nt={class:"form-actions"},Rt=["disabled"],jt={__name:"AdminView",setup(f){const r=i(!1),c=i(""),b=i(!1),m=i("");let p="";const o=i([]),h=i(!1),w=i(""),$=i(!1),V=i(!1),x=i(null),B=i(!1),F=i(!1),se=i(null),ae=i(null),L=i(""),z=i("info"),_=i(null),S=i([]),D=i([]),G=i(!1),j=i(""),E=i(""),A=i("");function Y(){const n=D.value.find(e=>e.name===j.value);return n?n.models:[]}function ne(){const e=Y().find(s=>s.name===E.value);return e?e.variants:[]}function le(){E.value="",A.value=""}function oe(){A.value=""}function ie(){if(!A.value)return;const n=D.value.find(l=>l.name===j.value);if(!n)return;const e=n.models.find(l=>l.name===E.value);if(!e)return;const s=e.variants.find(l=>l.specName===A.value);s&&(a.name=`${s.year} ${n.nameEn} ${e.name}`,a.slug=re(a.name),a.type=s.type||"SUV",a.range=s.range||0,a.seats=s.seats||5,a.specs.year=s.year||"2025",a.specs.make=n.nameEn,a.specs.model=e.name,a.specs.batteryCapacity=s.batteryCapacity||"N/A",a.specs.category="PASSENGER",C("Auto-filled from database: "+a.name,"success"))}async function q(){G.value=!0;try{const e=await fetch("https://raw.githubusercontent.com/OUTshipping/OUTshipping.github.io/source/public/data/brands.json");if(e.ok){const s=await e.json();D.value=s.brands||[],console.log(`Loaded ${D.value.length} brands from database`)}}catch(n){console.warn("Failed to load brands database:",n)}finally{G.value=!1}}const W=()=>({name:"",slug:"",type:"SUV",range:0,seats:5,configuration:"Basic",description:"",coverImage:"",colors:["#000000"],specs:{year:"2025",make:"",model:"",category:"",batteryCapacity:"N/A"},detailImages:[]}),a=Ce(W());function re(n){return n.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")}async function Q(){b.value=!0,m.value="";try{const n=await _e(c.value);n.valid?(p=c.value,r.value=!0,sessionStorage.setItem("gh_token",p),await H(),q()):m.value=n.message}catch(n){m.value=n.message}finally{b.value=!1}}function ue(){r.value=!1,p="",sessionStorage.removeItem("gh_token"),o.value=[]}async function H(){h.value=!0;try{const{content:n,sha:e}=await Z(p,"public/data/vehicles.json");o.value=JSON.parse(n),w.value=e}catch(n){C("Failed to load vehicles: "+n.message,"error")}finally{h.value=!1}}async function de(n){n.enabled=!n.enabled,await K("Toggle vehicle: "+n.name)}function ce(){Object.assign(a,W()),_.value=null,S.value=[],V.value=!1,x.value=null,$.value=!0}function pe(n){Object.assign(a,{name:n.name,slug:n.slug,type:n.type,range:n.range,seats:n.seats,configuration:n.configuration,description:n.description,coverImage:n.coverImage,colors:[...n.colors],specs:{...n.specs},detailImages:[...n.detailImages]}),_.value=null,S.value=[],V.value=!0,x.value=n.id,$.value=!0}function ve(){$.value=!1}function me(n){const e=n.target.files[0];if(!e)return;_.value=e;const s=new FileReader;s.onload=l=>{a.coverImage=l.target.result},s.readAsDataURL(e)}function ge(n){Array.from(n.target.files).forEach(s=>{S.value.push(s);const l=new FileReader;l.onload=y=>{a.detailImages.push(y.target.result)},l.readAsDataURL(s)})}function fe(n){a.detailImages.splice(n,1),n<S.value.length&&S.value.splice(n,1)}function X(n){return new Promise((e,s)=>{const l=new FileReader;l.onload=()=>{const y=l.result.split(",")[1];e(y)},l.onerror=s,l.readAsDataURL(n)})}function C(n,e="info"){L.value=n,z.value=e,setTimeout(()=>{L.value=""},5e3)}async function ye(n){confirm(`Are you sure you want to delete "${n.name}"?`)&&(o.value=o.value.filter(e=>e.id!==n.id),await K("Delete vehicle: "+n.name))}async function K(n){try{const e=JSON.stringify(o.value,null,2),s=await ee(p,"public/data/vehicles.json",e,w.value,n);w.value=s.content.sha,C("Saved successfully! Site will update in 1-2 minutes.","success")}catch(e){if(e.message&&e.message.includes("does not match"))try{C("SHA mismatch, retrying...","info");const{sha:s}=await Z(p,"public/data/vehicles.json");w.value=s;const l=JSON.stringify(o.value,null,2),y=await ee(p,"public/data/vehicles.json",l,w.value,n);w.value=y.content.sha,C("Saved successfully! Site will update in 1-2 minutes.","success")}catch(s){C("Save failed after retry: "+s.message,"error")}else C("Save failed: "+e.message,"error")}}async function be(){if(confirm("确认将当前数据部署到前台网站？")){F.value=!0;try{await Ae(p),C("Deployed successfully! Live site will update in ~1 minute.","success")}catch(n){C("Deploy failed: "+n.message,"error")}finally{F.value=!1}}}async function he(){if(!a.name||!a.slug||!a.type){C("Please fill in all required fields.","error");return}B.value=!0;try{const n=a.slug;if(_.value){const l=_.value.name.split(".").pop(),y=`public/vehicles/${n}/cover.${l}`,O=await X(_.value);await te(p,y,O,`Upload cover for ${a.name}`),a.coverImage=`/vehicles/${n}/cover.${l}`}const e=a.detailImages.length-S.value.length;for(let l=0;l<S.value.length;l++){const y=S.value[l],O=y.name.split(".").pop(),we=`public/vehicles/${n}/${e+l+1}.${O}`,ke=await X(y);await te(p,we,ke,`Upload image for ${a.name}`),a.detailImages[e+l]=`/vehicles/${n}/${e+l+1}.${O}`}const s={id:V.value?x.value:Math.max(0,...o.value.map(l=>l.id))+1,slug:a.slug,enabled:!0,name:a.name,type:a.type,range:a.range,seats:a.seats,configuration:a.configuration,coverImage:a.coverImage,colors:[...a.colors],description:a.description,specs:{...a.specs},detailImages:[...a.detailImages]};if(V.value){const l=o.value.findIndex(y=>y.id===x.value);l!==-1&&(s.enabled=o.value[l].enabled,o.value[l]=s)}else o.value.push(s);await K(V.value?`Update vehicle: ${a.name}`:`Add vehicle: ${a.name}`),$.value=!1,_.value=null,S.value=[]}catch(n){C("Save failed: "+n.message,"error")}finally{B.value=!1}}return $e(()=>{const n=sessionStorage.getItem("gh_token");n&&(p=n,r.value=!0,H(),q())}),(n,e)=>(d(),u("div",De,[r.value?(d(),u("div",Pe,[t("header",xe,[e[19]||(e[19]=t("h1",null,"Vehicle Management",-1)),t("div",Be,[t("button",{class:"btn-add",onClick:ce},"+ Add Vehicle"),t("button",{class:"btn-deploy",onClick:be,disabled:F.value},v(F.value?"Deploying...":"Deploy to Live Site"),9,Fe),t("button",{class:"btn-logout",onClick:ue},"Logout")])]),L.value?(d(),u("div",{key:0,class:Ue(["status-bar",z.value])},v(L.value),3)):T("",!0),$.value?T("",!0):(d(),u("div",Le,[t("div",Oe,[t("span",null,"Total: "+v(o.value.length)+" vehicles",1),t("button",{class:"btn-refresh",onClick:H,disabled:h.value},v(h.value?"Loading...":"Refresh"),9,Me)]),t("table",Je,[e[21]||(e[21]=t("thead",null,[t("tr",null,[t("th",null,"ID"),t("th",null,"Image"),t("th",null,"Name"),t("th",null,"Type"),t("th",null,"Range"),t("th",null,"Status"),t("th",null,"Actions")])],-1)),t("tbody",null,[(d(!0),u(N,null,R(o.value,s=>(d(),u("tr",{key:s.id},[t("td",null,v(s.id),1),t("td",null,[t("img",{src:s.coverImage,alt:s.name,class:"thumb"},null,8,Ge)]),t("td",null,v(s.name),1),t("td",null,v(s.type),1),t("td",null,v(s.range)+" km",1),t("td",null,[t("label",He,[t("input",{type:"checkbox",checked:s.enabled,onChange:l=>de(s)},null,40,Ke),e[20]||(e[20]=t("span",{class:"slider"},null,-1))])]),t("td",ze,[t("button",{class:"btn-edit",onClick:l=>pe(s)},"Edit",8,Ye),t("button",{class:"btn-delete",onClick:l=>ye(s)},"Delete",8,qe)])]))),128))])])])),$.value?(d(),u("div",We,[t("h2",null,v(V.value?"Edit Vehicle":"Add New Vehicle"),1),D.value.length>0?(d(),u("div",Qe,[e[28]||(e[28]=t("h3",{class:"db-selector-title"},"Quick Fill from Database",-1)),e[29]||(e[29]=t("p",{class:"db-selector-hint"},"Select brand, model and variant to auto-fill the form fields below.",-1)),t("div",Xe,[t("div",Ze,[e[23]||(e[23]=t("label",null,"Brand",-1)),g(t("select",{"onUpdate:modelValue":e[1]||(e[1]=s=>j.value=s),onChange:le},[e[22]||(e[22]=t("option",{value:""},"-- Select Brand --",-1)),(d(!0),u(N,null,R(D.value,s=>(d(),u("option",{key:s.name,value:s.name},v(s.name)+" ("+v(s.nameEn)+") ",9,et))),128))],544),[[P,j.value]])]),t("div",tt,[e[25]||(e[25]=t("label",null,"Model",-1)),g(t("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>E.value=s),onChange:oe,disabled:!j.value},[e[24]||(e[24]=t("option",{value:""},"-- Select Model --",-1)),(d(!0),u(N,null,R(Y(),s=>(d(),u("option",{key:s.name,value:s.name},v(s.name),9,at))),128))],40,st),[[P,E.value]])]),t("div",nt,[e[27]||(e[27]=t("label",null,"Variant",-1)),g(t("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>A.value=s),disabled:!E.value},[e[26]||(e[26]=t("option",{value:""},"-- Select Variant --",-1)),(d(!0),u(N,null,R(ne(),s=>(d(),u("option",{key:s.specName,value:s.specName},v(s.specName)+" ("+v(s.range)+"km) ",9,ot))),128))],8,lt),[[P,A.value]])]),t("button",{class:"btn-apply-variant",onClick:ie,disabled:!A.value}," Apply ",8,it)])])):G.value?(d(),u("div",rt,[...e[30]||(e[30]=[t("p",{style:{"text-align":"center",color:"#999"}},"Loading brands database...",-1)])])):T("",!0),t("div",ut,[t("div",dt,[e[31]||(e[31]=t("label",null,"Name *",-1)),g(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>a.name=s),type:"text",placeholder:"e.g. 2025 BYD Song Plus"},null,512),[[k,a.name]])]),t("div",ct,[e[32]||(e[32]=t("label",null,"Slug *",-1)),g(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>a.slug=s),type:"text",placeholder:"e.g. song-plus"},null,512),[[k,a.slug]])]),t("div",pt,[e[34]||(e[34]=t("label",null,"Type *",-1)),g(t("select",{"onUpdate:modelValue":e[6]||(e[6]=s=>a.type=s)},[...e[33]||(e[33]=[Ie('<option value="SUV" data-v-2f8be261>SUV</option><option value="SEDAN" data-v-2f8be261>SEDAN</option><option value="VAN" data-v-2f8be261>VAN</option><option value="PICKUP" data-v-2f8be261>PICKUP</option><option value="TRUCK" data-v-2f8be261>TRUCK</option><option value="REFRIGERATED" data-v-2f8be261>REFRIGERATED</option><option value="BUS" data-v-2f8be261>BUS</option>',7)])],512),[[P,a.type]])]),t("div",vt,[e[35]||(e[35]=t("label",null,"Range (km) *",-1)),g(t("input",{"onUpdate:modelValue":e[7]||(e[7]=s=>a.range=s),type:"number",placeholder:"e.g. 520"},null,512),[[k,a.range,void 0,{number:!0}]])]),t("div",mt,[e[36]||(e[36]=t("label",null,"Seats *",-1)),g(t("input",{"onUpdate:modelValue":e[8]||(e[8]=s=>a.seats=s),type:"number",placeholder:"e.g. 5"},null,512),[[k,a.seats,void 0,{number:!0}]])]),t("div",gt,[e[38]||(e[38]=t("label",null,"Configuration",-1)),g(t("select",{"onUpdate:modelValue":e[9]||(e[9]=s=>a.configuration=s)},[...e[37]||(e[37]=[t("option",{value:"Basic"},"Basic",-1),t("option",{value:"Premium"},"Premium",-1),t("option",{value:"Commercial"},"Commercial",-1)])],512),[[P,a.configuration]])]),t("div",ft,[e[39]||(e[39]=t("label",null,"Description",-1)),g(t("textarea",{"onUpdate:modelValue":e[10]||(e[10]=s=>a.description=s),rows:"4",placeholder:"Vehicle description..."},null,512),[[k,a.description]])])]),e[45]||(e[45]=t("h3",null,"Specifications",-1)),t("div",yt,[t("div",bt,[e[40]||(e[40]=t("label",null,"Year",-1)),g(t("input",{"onUpdate:modelValue":e[11]||(e[11]=s=>a.specs.year=s),type:"text",placeholder:"2025"},null,512),[[k,a.specs.year]])]),t("div",ht,[e[41]||(e[41]=t("label",null,"Make",-1)),g(t("input",{"onUpdate:modelValue":e[12]||(e[12]=s=>a.specs.make=s),type:"text",placeholder:"BYD"},null,512),[[k,a.specs.make]])]),t("div",wt,[e[42]||(e[42]=t("label",null,"Model",-1)),g(t("input",{"onUpdate:modelValue":e[13]||(e[13]=s=>a.specs.model=s),type:"text",placeholder:"Song Plus"},null,512),[[k,a.specs.model]])]),t("div",kt,[e[43]||(e[43]=t("label",null,"Category",-1)),g(t("input",{"onUpdate:modelValue":e[14]||(e[14]=s=>a.specs.category=s),type:"text",placeholder:"PASSENGER"},null,512),[[k,a.specs.category]])]),t("div",Ct,[e[44]||(e[44]=t("label",null,"Battery Capacity",-1)),g(t("input",{"onUpdate:modelValue":e[15]||(e[15]=s=>a.specs.batteryCapacity=s),type:"text",placeholder:"71.7 kWh"},null,512),[[k,a.specs.batteryCapacity]])])]),e[46]||(e[46]=t("h3",null,"Colors",-1)),t("div",$t,[(d(!0),u(N,null,R(a.colors,(s,l)=>(d(),u("div",{key:l,class:"color-item"},[g(t("input",{type:"color","onUpdate:modelValue":y=>a.colors[l]=y},null,8,St),[[k,a.colors[l]]]),t("span",null,v(s),1),t("button",{class:"btn-remove-sm",onClick:y=>a.colors.splice(l,1)},"x",8,Ut)]))),128)),t("button",{class:"btn-add-color",onClick:e[16]||(e[16]=s=>a.colors.push("#000000"))},"+ Add Color")]),e[47]||(e[47]=t("h3",null,"Cover Image",-1)),t("div",It,[a.coverImage?(d(),u("div",Vt,[t("img",{src:a.coverImage,alt:"Cover",class:"preview-img"},null,8,_t)])):T("",!0),t("input",{type:"file",accept:"image/*",onChange:me,ref_key:"coverInput",ref:se},null,544)]),e[48]||(e[48]=t("h3",null,"Detail Images",-1)),t("div",At,[t("div",Dt,[(d(!0),u(N,null,R(a.detailImages,(s,l)=>(d(),u("div",{key:l,class:"detail-img-item"},[t("img",{src:s,alt:"Detail",class:"preview-img-sm"},null,8,Et),t("button",{class:"btn-remove-sm",onClick:y=>fe(l)},"x",8,Tt)]))),128))]),t("input",{type:"file",accept:"image/*",multiple:"",onChange:ge,ref_key:"detailInput",ref:ae},null,544)]),t("div",Nt,[t("button",{class:"btn-save",onClick:he,disabled:B.value},v(B.value?"Saving...":"Save"),9,Rt),t("button",{class:"btn-cancel",onClick:ve},"Cancel")])])):T("",!0)])):(d(),u("div",Ee,[t("div",Te,[e[17]||(e[17]=t("h1",null,"TG Automobile Admin",-1)),e[18]||(e[18]=t("p",{class:"login-desc"},"Enter your GitHub Personal Access Token to manage vehicles.",-1)),t("div",Ne,[g(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>c.value=s),type:"password",placeholder:"GitHub Personal Access Token",onKeyup:Se(Q,["enter"])},null,544),[[k,c.value]]),t("button",{onClick:Q,disabled:b.value},v(b.value?"Verifying...":"Login"),9,Re),m.value?(d(),u("p",je,v(m.value),1)):T("",!0)])])]))]))}},Bt=Ve(jt,[["__scopeId","data-v-2f8be261"]]);export{Bt as default};
